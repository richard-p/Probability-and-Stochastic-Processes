This is the C++ implementation.
